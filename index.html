<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Content testing and deployment done the right way</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/contentful.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background-image="images/bg1.png">
					<img src="images/contentful-white.svg">

					<h3>Content testing and deployment <br/>done the right way</h3>
					<div style="display: flex; flex-flow: column; align-items: center;">
						<img src="images/bug.png" style="flex-grow: 0; width: 5em; margin-bottom: 0;">
						<p style="font-size: 0.5em;">By Shy Ruparel</p>
					</div>
				</section>

				<section data-background-image="images/bg1.png">
					<img src="images/contentful-white.svg">

					<h3>Content model changes<br/>done the right way<br> part 2.</h3>
					<div style="display: flex; flex-flow: column; align-items: center;">
						<img src="images/bug.png" style="flex-grow: 0; width: 5em; margin-bottom: 0;">
						<p style="font-size: 0.5em;">By Shy Ruparel</p>
					</div>
				</section>
		<!--		<section data-background-image="images/about-contentful.png"></section> -->

				<section data-background-image="images/bg1.png">
					<img src="images/contentful-white.svg"><br>
					<img src="images/shy.jpg" style="border-radius: 50%; height: 5em;">
					<h3 style="margin-bottom: 0; line-height: 1.1;">Shy Ruparel</h3>
					<img src="images/bug.png" style="width: 7em; margin: 0;">
					<p style="font-size: 0.5em; line-height: 1;">Developer Evangelist<p>
					<p style="font-size: 0.5em; line-height: 1;">Twitter: <a href="http://www.twitter.com/shyruparel">@ShyRuparel</a><p>
				</section>

				<section data-background-image="images/bg3.png">
					<h2>Building Software</h2>
					<h3></h3>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bg2.png">
					<h2><i>Nobody</i> gets it right the first time</h2>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bg6.png">
					<h2>When you canâ€™t have perfection, the next best thing is change.</h2>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>What could go wrong?</h4>
					<img src="images/production-meme.jpg">
				</section>

				<section data-background-image="images/bg2.png">
					<h3>In a past meetup we talked about the <br>Contentful Migration CLI ðŸšš</h3>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>TL;DR</h4>
					<h4>What you can do</h4>
					<ul>
						<li class="fragment">Create content type</li>
						<li class="fragment">Delete content type</li>
						<li class="fragment">Edit content type</li>
						<li class="fragment">Create/edit/delete fields</li>
						<li class="fragment">Change field ID</li>
					</ul>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>All in Javascript</h4>
					<pre><code data-trim style="overflow: hidden;">
contentful-migration
    --space-id $YOUR_SPACE_ID
    --access-token $CONTENTFUL_MANAGEMENT_ACCESS_TOKEN
    migration-demo.js
					</code></pre>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>Advantages</h4>
					<ul>
						<li class="fragment">Repeatable</li>
						<li class="fragment">Dry-runs</li>
						<li class="fragment">Can be kept in version control</li>
						<li class="fragment">Sanity checks</li>
						<li class="fragment">Use CI to apply.</li>
					</ul>
					<aside class="notes">
						Don't need admin permission for everyone to let them make changes!
					</aside>
				</section>

				<section data-background-image="images/bg6.png">
					<h3>That's nice</h3>
					<h4 class="fragment">But what if I want to discard, test or preview a migration?</h4>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
					<br>
					<img class="fragment" src="images/shocked.jpg" style="height: 40vh;">
				</section>

				<section data-background-image="images/bg2.png">
					<h3>Space Environments ðŸš€</h3>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>


				<section data-background-image="images/bgplain.png">
					<h4>Space environments allow you to create multiple versions of the space, and change them in isolation.</h4>
					<img src="images/environments-page.png">
				</section>


				<section data-background-image="images/bgplain.png">
					<h3>Common uses for space environments</h3>
					<ul>
						<li class="fragment">Local development</li>
						<li class="fragment">Staging / QA</li>
						<li class="fragment">Continuous integration</li>
					</ul>
				</section>

				<section data-background-image="images/bg3.png">
					<h3>Let's talk about</h3>
					<h2>Continuous Integration</h2>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bgplain.png">
					<h3>A simple Continuous Integration pipeline:</h3>
					<ul>
						<li class="fragment">Build</li>
						<li class="fragment">Test</li>
						<li class="fragment">Deploy</li>
					</ul>
				</section>

				<section data-background-image="images/bgplain.png">
					<h3>Integrating Migrations into CI Pipeline:</h3>
					<ul>
						<li class="fragment">Build</li>
						<ul>
							<li class="fragment"><i>Spin up a copy of the master space</li>
							<li class="fragment">Migrate copy</li></i>
						</ul>
						<li class="fragment">Test</li>
						<li class="fragment">Deploy</li>
						<ul>
							<i><li class="fragment">Migrate master space</li></i>
						</ul>
					</ul>
				</section>


				<section data-background-image="images/bgplain.png">
					<img src="images/circle-logo.png">
				</section>

				<section data-background-image="images/bgplain.png">
					<h3>Build</h3>
					<img src="images/circleci-build.png">
				</section>

				<section data-background-image="images/bgplain.png">
					<h3>Deploy</h3>
					<img src="images/circleci-deploy.png">
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>CircleCI config.yml - Ready Migrations</h4>
					<pre><code data-trim data-noescape>
- run:
      name: Preparing environment for testing
      command: |
        . venv/bin/activate
        python migration_prep.py "circletesting_$CIRCLE_BRANCH"
        node_modules/contentful-migration/bin/contentful-migration
        	--access-token $MANGEMENT_API_KEY --space-id $SPACE_ID
        	--environment-id "circletesting_$CIRCLE_BRANCH"
			--yes
        	migration-tests/migration_helper.js
					</code></pre>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>migration_prep.py</h4>
					<pre><code data-trim data-noescape>
import contentful_management
import os, sys
from dotenv import load_dotenv

SPACE_ID = os.getenv("SPACE_ID")
MANGEMENT_API_KEY = os.getenv("MANGEMENT_API_KEY")
TESTING_ENV = sys.argv[1]

client = contentful_management.Client(MANGEMENT_API_KEY)
environment = client.environments(SPACE_ID)
			.create(TESTING_ENV, {"name": TESTING_ENV})
					</code></pre>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>migration_helper.js</h4>
					<pre><code data-trim data-noescape>
module.exports = function(migration) {
	var parsedJSON = require("./version.json");
    const expectedVersion = parsedJSON.expectedVersion;
    const upgradeVersion = parsedJSON.upgradeVersion;

    migrationString =
            "./content_migration_" +
            upgradeVersion.split(".").join("_") +
            ".js";
        var migrationCode = require(migrationString);

        if (migrationCode.validateVersion(expectedVersion, upgradeVersion)) {
            migrationCode.runMigration(migration);
        } else {
            console.log("Migration Version Mismatch");
            process.exit(1);
        }

}
					</code></pre>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>Migration Files</h4>
					<img src="images/migration-list.png">
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>content_migration_0_0_7.js pt 1</h4>
					<pre><code data-trim data-noescape>
const migration_expected_version = "0.0.6";
const migration_upgrade_version = "0.0.7";

function validateVersion(expected_version, upgrade_version) {
    if (upgrade_version == migration_upgrade_version) {
        if (expected_version == migration_expected_version) {
            return true;
        }
    }
    return false;
}

					</code></pre>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>content_migration_0_0_7.js pt 2</h4>
					<pre><code data-trim data-noescape>
function runMigration(migration) {
    const post = migration.editContentType("post");
    post
        .createField("author")
        .name("author")
        .type("Symbol")
        .required(false);
    return;
}

module.exports = {
    runMigration,
    validateVersion
};

					</code></pre>
				</section>

				<section data-background-image="images/bgplain.png">
					<h4>CircleCI config.yml - Run Tests</h4>
					<pre><code data-trim data-noescape>
- run:
      name: run tests
      command: |
        . venv/bin/activate
        pytest --environment-id="circletesting_$CIRCLE_BRANCH"
					</code></pre>
				</section>

				<section data-background-image="images/bg3.png">
					<h2>Demo</h2>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bg2.png">
					<h3>Integrate evolving your content model into your delivery pipeline</h3>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bg2.png">
					<h3>Check out the example app:</h3>
					<h5>github.com/contentful-labs/continous-delivery-environments-example</h5>
					<img src="images/bug.png" style="width: 7em; margin-top: 0;">
				</section>

				<section data-background-image="images/bg1.png">
					<img src="images/contentful-white.svg"><br>
					<img src="images/shy.jpg" style="border-radius: 50%; height: 5em;">
					<h3 style="margin-bottom: 0; line-height: 1.1;">Shy Ruparel</h3>
					<img src="images/bug.png" style="width: 7em; margin: 0;">
					<p style="font-size: 0.5em; line-height: 1;">Twitter: <a href="http://www.twitter.com/shyruparel">@ShyRuparel</a><p>
					<p style="font-size: 0.5em; line-height: 1;">Email: <a href="mailto:shy@contentful.com">shy@contentful.com</a><p>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
        controls: false,
        history: true,
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
